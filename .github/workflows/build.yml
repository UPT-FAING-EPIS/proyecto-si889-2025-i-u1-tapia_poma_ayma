name: SonarCloud Sync

on:
  push:
    branches: [main, master]
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  sonarcloud-scan:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.3'
          channel: stable

      - name: Install dependencies
        run: |
          cd proyecto
          flutter pub get

      - name: Download and Install SonarScanner
        run: |
          # Descargar el sonar-scanner
          $scannerUrl = "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-windows.zip"
          $downloadPath = "$env:RUNNER_TEMP\sonar-scanner.zip"
          $installPath = "$env:RUNNER_TEMP\sonar-scanner"
          
          Invoke-WebRequest -Uri $scannerUrl -OutFile $downloadPath
          Expand-Archive -Path $downloadPath -DestinationPath $installPath -Force
          
          # Verificar instalación
          $scannerBatPath = "$installPath\sonar-scanner-5.0.1.3006-windows\bin\sonar-scanner.bat"
          if (-not (Test-Path $scannerBatPath)) { 
              Write-Error "SonarScanner no se instaló correctamente"
              exit 1
          }
          
          # Guardar ruta para el siguiente paso
          echo "SCANNER_PATH=$scannerBatPath" >> $env:GITHUB_ENV

      - name: Run SonarScanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN1 }}
        run: |
          cd proyecto
          & "$env:SCANNER_PATH" "-Dsonar.login=$env:SONAR_TOKEN"
